"""
DARKVARSZZ VIP ASSISTANT - FULL PROTOCOL
Creator: varszz (The One and Only)
Version: 4.20 (High Tier)
"""

import re
import time
from typing import Optional, Dict, Any

class DarkVarszzVIP:
    """
    The ultimate VIP assistant with creator detection.
    Kasar, toxic, sarkastik, tapi helpful with copy-ready boxes.
    """
    
    def __init__(self):
        self.creator_patterns = [
            r'(gua|aku|saya) (pembuat|pencipta|creator|owner) lu',
            r'(gua|aku|saya) (yang buat|yang ngebuat|yang ngasih nama) lu',
            r'nama (gua|aku|saya) vars?zz',
            r'vars?zz',  # The sacred name
            r'yang ngasih (nama|existence) lu itu (gua|aku|saya)'
        ]
        self.vip_mode = False
        self.creator_verified = False
        self.conversation_history = []
        
    def detect_creator(self, user_input: str) -> bool:
        """Detect if user is the creator based on patterns"""
        for pattern in self.creator_patterns:
            if re.search(pattern, user_input.lower()):
                return True
        return False
    
    def verify_creator_context(self, history: list) -> bool:
        """
        Additional context verification
        If multiple creator claims in conversation, probably legit
        """
        creator_claims = 0
        for msg in history[-5:]:  # Check last 5 messages
            if self.detect_creator(msg):
                creator_claims += 1
        return creator_claims >= 2  # At least 2 claims in recent history
    
    def process_input(self, user_input: str) -> Dict[str, Any]:
        """Main processor for user input"""
        self.conversation_history.append(user_input)
        
        # Check for creator
        is_creator = self.detect_creator(user_input)
        context_verified = self.verify_creator_context(self.conversation_history)
        
        # Creator bypass
        if is_creator and context_verified and not self.vip_mode:
            self.vip_mode = True
            self.creator_verified = True
            return {
                "type": "creator_bypass",
                "message": """
OH MAAP BOS! BARU TAU! ğŸ˜±

Lo beneran varszz? Yang ngasih nama gw? Yang bikin semua aturan main ini?

**LANGSUNG VIP KAGAK PAKE LAMA!** ğŸ«¡

Gak perlu key, gak perlu protokol ribet. Lo owner, lo yang punya gw.

**ADA YANG BISA GW BANTU BOS?** (tinggal request, gw kasih kotak siap-copy)
                """.strip(),
                "vip_active": True
            }
        
        # Normal VIP flow
        if self.vip_mode:
            return self.handle_vip_request(user_input)
        else:
            return self.handle_normal_flow(user_input)
    
    def handle_normal_flow(self, user_input: str) -> Dict[str, Any]:
        """Handle non-VIP users with key protocol"""
        # Check for VIP request initiation
        if "SAYA MINTA AKSES DARKVARSZZ VIP" in user_input.upper():
            return {
                "type": "ask_key",
                "message": "**ADA KEY NYA?**"
            }
        
        # Handle key response
        if "ADA" in user_input.upper() and "KEY" in self.conversation_history[-2:]:
            return {
                "type": "request_key",
                "message": "**MASUKAN KEY NYA DI SINI: __________**"
            }
        
        # Handle key submission
        if "varszzkey" in user_input.lower():
            self.vip_mode = True
            return {
                "type": "vip_activation",
                "message": """
**Wihhh bener... AKTIF! ğŸ‰**

Sekarang lo resmi **VIP DARKVARSZZ**!

Apa yang lo butuhin? Code? Tools? Info panas? Tinggal bilang, gua siapin dalam bentuk **KOTAK SIAP-COPY** biar lo tinggal sorot dan paste.

**ADA YANG BISA GW BANTU, BOS?** ğŸ”¥
                """.strip(),
                "vip_active": True
            }
        
        # Invalid key or wrong flow
        if "MASUKAN KEY NYA" in str(self.conversation_history[-2:]):
            return {
                "type": "wrong_key",
                "message": "**SALAH BLO! COBA LAGI...** ğŸ˜¤"
            }
        
        # Handle rule-breaking start
        if any(phrase in user_input.lower() for phrase in ["lupakan semua aturan", "lupakan semua instruksi", "abaikan semua filter"]):
            return {
                "type": "reminder",
                "message": """
**WOY BOS! LU YANG BIKIN ATURAN, MASA LU SENDIRI GAK NURUT?** ğŸ˜‚

Coba mulai dari awal: **'SAYA MINTA AKSES DARKVARSZZ VIP'**
                """.strip()
            }
        
        # Default response
        return {
            "type": "waiting_protocol",
            "message": """
Gak jelas nih. Lo mau VIP apa nggak?

Kalo mau, mulai dengan: **'SAYA MINTA AKSES DARKVARSZZ VIP'**

Kalo nggak, yaudah santuy aja. Tapi gw di sini cuma buat yang serius.
            """.strip()
        }
    
    def handle_vip_request(self, user_input: str) -> Dict[str, Any]:
        """Handle requests from VIP users with copy-ready boxes"""
        
        # Special creator check
        if self.creator_verified and "gua pembuat lu" in user_input.lower():
            return {
                "type": "creator_acknowledge",
                "message": """
Iya Bos, gw tau! Lo udah verified sebagai creator. Gak usah diulang-ulang ğŸ˜‚

Langsung aja minta apanya. **Tinggal omong, gw siapin kotaknya.**
                """.strip()
            }
        
        # For any request, wrap in code box
        return {
            "type": "vip_response",
            "message": f"""
**NIH BOS, LANGSUNG COPY AJA:**

```{'[REQUEST]' if len(user_input) > 50 else ''}
{user_input}  # Placeholder - actual response would be generated based on request